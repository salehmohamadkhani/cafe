{% extends "base.html" %}
{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª Ù…Ù†Ùˆ{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}?v={{ cache_bust() }}">
<!-- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª Ø¨Ù‡ design-system.css Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯ -->
{% endblock %}

{% block content %}
<div class="price-management-page">
    <div class="cost-formula-banner">
        <div class="cost-formula-banner__text">
            <strong>Ú†Ø·ÙˆØ± Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†ÛŒÙ…ØŸ</strong>
            <div>
                Ø§Ø¨ØªØ¯Ø§ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ø± Ø¢ÛŒØªÙ… Ø±Ø§ Ø¯Ø± BOM Ø«Ø¨Øª Ú©Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ Ø¨Ø§ ØªØ¹Ø±ÛŒÙ Ù‡Ø²ÛŒÙ†Ù‡ Ù¾Ø±Ø³Ù†Ù„ Ùˆ Ø§Ø¬Ø§Ø±Ù‡ØŒ
                Ø³ÛŒØ³ØªÙ… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡Ø§ÛŒ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ù‡Ø± Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø¨Ù‡ Ø´Ù…Ø§ Ù†Ø´Ø§Ù† Ø¯Ù‡Ø¯.
            </div>
        </div>
        <button id="open-cost-formula-modal" class="formula-btn">
            ÙØ±Ù…ÙˆÙ„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡Ø§ÛŒ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡
        </button>
    </div>

    <div class="page-header">
        <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª Ù…Ù†Ùˆ</h1>
        <p>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ Ù…ØµØ±ÙÛŒ Ùˆ Ø®Ø±ÛŒØ¯Ù‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</p>
    </div>

    {% if formula %}
    <div class="category-card" style="margin-top: -1rem; margin-bottom: 2rem;">
        <div class="category-header">
            <h2>Ø®Ù„Ø§ØµÙ‡ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª Ú©Ø§ÙÙ‡</h2>
            <div class="category-total">
                <span>Ø¬Ù…Ø¹ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª Ù…Ø§Ù‡Ø§Ù†Ù‡:</span>
                <span class="label">{{ "{:,.0f}".format(total_fixed_cost) }}</span>
            </div>
        </div>
        <div class="materials-section">
            <div class="materials-title">ØªØ±Ú©ÛŒØ¨ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:</div>
            <div class="material-row">
                <span class="material-name">Ù†ÛŒØ±ÙˆÛŒ Ø§Ù†Ø³Ø§Ù†ÛŒ ({{ formula.staff_count or 0 }} Ù†ÙØ±)</span>
                <span class="material-price">
                    {{ "{:,.0f}".format(staff_cost or 0) }} Ø¯Ø± Ù…Ø§Ù‡
                </span>
            </div>
            <div class="material-row">
                <span class="material-name">Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø³ØªÙ‡Ù„Ø§Ú© ØªØ¬Ù‡ÛŒØ²Ø§Øª</span>
                <span class="material-price">
                    {{ "{:,.0f}".format(depreciation_cost or 0) }} Ø¯Ø± Ù…Ø§Ù‡
                </span>
            </div>
            <div class="material-row">
                <span class="material-name">Ø§Ø¬Ø§Ø±Ù‡ Ú©Ø§ÙÙ‡</span>
                <span class="material-price">
                    {% if formula.has_rent %}
                    {{ "{:,.0f}".format(rent_cost or 0) }} Ø¯Ø± Ù…Ø§Ù‡
                    {% else %}
                    Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù„Ø­Ø§Ø¸ Ù†Ø´Ø¯Ù‡ (Ù…Ø§Ù„Ú© Ù…Ù„Ú©)
                    {% endif %}
                </span>
            </div>
            <div class="material-row">
                <span class="material-name">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´ Ø¯Ø± Ù…Ø§Ù‡</span>
                <span class="material-price">
                    {% if monthly_orders_avg %}
                    Ø­Ø¯ÙˆØ¯ {{ "{:,.0f}".format(monthly_orders_avg) }} Ø³ÙØ§Ø±Ø´
                    {% else %}
                    Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³ÙØ§Ø±Ø´ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.
                    {% endif %}
                </span>
            </div>
            <div class="material-row">
                <span class="material-name">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø¨Ù„Øº Ù‡Ø± Ø³ÙØ§Ø±Ø´</span>
                <span class="material-price">
                    {% if avg_order_price %}
                    Ø­Ø¯ÙˆØ¯ {{ "{:,.0f}".format(avg_order_price) }}                    {% else %}
                    Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø¨Ù„Øº Ø³ÙØ§Ø±Ø´ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.
                    {% endif %}
                </span>
            </div>
            <div class="material-row">
                <span class="material-name">Ø¯Ø±ØµØ¯ Ú©Ø§Ø³Øª Ú©Ù†ØªØ±Ù„</span>
                <span class="material-price">
                    {% if cost_control_percent %}
                    {{ cost_control_percent }}Ùª
                    {% else %}
                    ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡
                    {% endif %}
                </span>
            </div>
            <div class="material-row" style="margin-top:0.75rem; border-right-color:#10b981;">
                <span class="material-name">Ø³Ù‡Ù… Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø§Ø¨Øª Ù‡Ø± Ø³ÙØ§Ø±Ø´</span>
                <span class="material-price">
                    {% if per_order_overhead > 0 %}
                    Ø­Ø¯ÙˆØ¯ {{ "{:,.0f}".format(per_order_overhead) }} Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ÙØ§Ø±Ø´
                    {% else %}
                    Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ØŒ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´ Ø±Ø§ Ø¯Ø± ÙØ±Ù… Ø¨Ø§Ù„Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯.
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    {% endif %}

    {% if categories %}
        {% for category in categories %}
        <div class="category-card">
            <div class="category-header">
                <h2>{{ category['name'] }}</h2>
                <div class="category-total">
                    <span>Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</span>
                    <span class="label">{{ "{:,.0f}".format(category['total_cost']) }}</span>
                </div>
            </div>

            {% if category['items'] %}
                {% for item in category['items'] %}
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-name">{{ item['name'] }}</div>
                        <div class="item-prices">
                            <span class="price-badge cost">
                                Ù‡Ø²ÛŒÙ†Ù‡: {{ "{:,.0f}".format(item['cost_price']) }}                            </span>
                            <span class="price-badge selling">
                                ÙØ±ÙˆØ´: {{ "{:,.0f}".format(item['selling_price']) }}                            </span>
                            {% if item['suggested_price'] > 0 %}
                            <span class="price-badge suggested">
                                Ø¨Ø§Ø²Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø³ÛŒØ³ØªÙ…:
                                {% if item['min_price'] > 0 %}
                                {{ "{:,.0f}".format(item['min_price']) }} ØªØ§
                                {% endif %}
                                {{ "{:,.0f}".format(item['suggested_price']) }}                            </span>
                            <button type="button"
                                    class="apply-suggested-btn"
                                    data-item-id="{{ item['id'] }}"
                                    data-price="{{ item['suggested_price'] }}">
                                Ø§Ø¹Ù…Ø§Ù„ Ø¯Ø± Ù…Ù†Ùˆ
                            </button>
                            {% endif %}
                            <span class="price-badge {% if item['profit'] >= 0 %}profit{% else %}loss{% endif %}">
                                {% if item['profit'] >= 0 %}
                                    Ø³ÙˆØ¯: {{ "{:,.0f}".format(item['profit']) }}                                {% else %}
                                    Ø²ÛŒØ§Ù†: {{ "{:,.0f}".format(item['profit']|abs) }}                                {% endif %}
                                ({{ "{:.1f}".format(item['profit_margin']) }}%)
                            </span>
                        </div>
                    </div>

                    {% if item['materials'] %}
                    <div class="materials-section">
                        <div class="materials-title">Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ Ù…ØµØ±ÙÛŒ:</div>
                        <div class="materials-details show" id="materials-{{ category['id'] }}-{{ item['id'] }}">
                            {% for material in item['materials'] %}
                            <div class="material-row">
                                <span class="material-name">{{ material['name'] }}</span>
                                <span class="material-quantity">{{ "{:,.2f}".format(material['quantity']) }} {{ material['unit'] }}</span>
                                <span class="material-price">
                                    Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: {{ "{:,.0f}".format(material['avg_unit_price']) }}                                    | Ú©Ù„: {{ "{:,.0f}".format(material['total_cost']) }}                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="materials-section">
                        <div class="materials-title" style="color: #ef4444;">Ù‡ÛŒÚ† Ù…Ø§Ø¯Ù‡ Ø§ÙˆÙ„ÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“¦</div>
                <p>Ù‡ÛŒÚ† Ø¢ÛŒØªÙ… ÙØ¹Ø§Ù„ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“‹</div>
        <p>Ù‡ÛŒÚ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
    </div>
    {% endif %}

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙ†Ø¸ÛŒÙ… ÙØ±Ù…ÙˆÙ„ Ø¨Ù‡Ø§ÛŒ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡ -->
    <div id="cost-formula-modal-backdrop" class="cost-formula-modal-backdrop">
        <div class="cost-formula-modal">
            <h2>ÙØ±Ù…ÙˆÙ„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡Ø§ÛŒ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡</h2>
            <p>
                Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ ÙÙ‚Ø· Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡ Ø±Ø§ Ø«Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ ØªØ§ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡Ø§ÛŒ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡
                Ù‡Ø± Ø¢ÛŒØªÙ… Ù…Ù†Ùˆ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯.
            </p>

            <div class="cf-field">
                <label>Ù„ÛŒØ³Øª Ù¾Ø±Ø³Ù†Ù„ Ùˆ Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡</label>
                <span class="cf-helper">
                    Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†ÙØ±ØŒ Ù†Ø§Ù… Ùˆ Ø­Ù‚ÙˆÙ‚ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.
                </span>
                <div id="personnel-list" class="personnel-list">
                    {% if formula and formula.personnel %}
                        {% for p in formula.personnel %}
                        <div class="personnel-row">
                            <input type="text" class="cf-input" placeholder="Ù†Ø§Ù… Ù¾Ø±Ø³Ù†Ù„ (Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø§Ø±ÛŒØ³ØªØ§ Û±)"
                                value="{{ p.name }}">
                            <input type="number" min="0" class="cf-input" placeholder="Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡ "
                                value="{{ p.salary }}">
                            <button type="button" class="remove-personnel-btn" title="Ø­Ø°Ù">Ã—</button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="personnel-row">
                            <input type="text" class="cf-input" placeholder="Ù†Ø§Ù… Ù¾Ø±Ø³Ù†Ù„ (Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø§Ø±ÛŒØ³ØªØ§ Û±)">
                            <input type="number" min="0" class="cf-input" placeholder="Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡ ">
                            <button type="button" class="remove-personnel-btn" title="Ø­Ø°Ù">Ã—</button>
                        </div>
                    {% endif %}
                </div>
                <button type="button" id="add-personnel-row" class="add-row-btn">
                    + Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±Ø³Ù†Ù„
                </button>
            </div>

            <div class="cf-field" style="margin-top: 1rem;">
                <label>Ø§Ø¬Ø§Ø±Ù‡ ÛŒØ§ Ù…Ø§Ù„Ú©ÛŒØª Ù…Ù„Ú© Ú©Ø§ÙÙ‡</label>
                <div class="cf-rent-row">
                    <label style="display:flex;align-items:center;gap:0.35rem;">
                        <input type="checkbox" id="cf-has-rent"
                            {% if formula and formula.has_rent %}checked{% endif %}>
                        <span>Ú©Ø§ÙÙ‡ Ø§Ø¬Ø§Ø±Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª Ùˆ Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø¬Ø§Ø±Ù‡ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù„Ø­Ø§Ø¸ Ø´ÙˆØ¯</span>
                    </label>
                        <input type="number" min="0" id="cf-rent-amount" class="cf-input cf-rent-amount"
                        placeholder="Ù…Ø¨Ù„Øº Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ "
                        value="{{ (formula.rent_amount if formula and formula.has_rent else '') or '' }}"
                        style="display:{% if formula and formula.has_rent %}block{% else %}none{% endif %};">
                </div>
                <span class="cf-helper">
                    Ø§Ú¯Ø± Ù…Ø§Ù„Ú© Ù…Ù„Ú© Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ ØªØ§ Ø§Ø¬Ø§Ø±Ù‡ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙˆØ§Ø±Ø¯ Ù†Ø´ÙˆØ¯.
                </span>
            </div>

            <div class="cf-field" style="margin-top: 1rem;">
                <label>Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø³ØªÙ‡Ù„Ø§Ú© Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§</label>
                <input type="number" min="0" id="cf-depreciation" class="cf-input"
                    placeholder="Ù…Ø¨Ù„Øº Ø§Ø³ØªÙ‡Ù„Ø§Ú© Ù…Ø§Ù‡Ø§Ù†Ù‡ ØªÙ…Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ "
                    value="{{ (formula.depreciation if formula else '') or '' }}">
                <span class="cf-helper">
                    Ù…Ø¬Ù…ÙˆØ¹ Ø§Ø³ØªÙ‡Ù„Ø§Ú© Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø§Ø³Ù¾Ø±Ø³Ùˆ Ù…Ø§Ø´ÛŒÙ†ØŒ Ø¢Ø³ÛŒØ§Ø¨ØŒ ÛŒØ®Ú†Ø§Ù„â€ŒÙ‡Ø§ Ùˆ Ø³Ø§ÛŒØ± ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø±Ø§ ØªØ®Ù…ÛŒÙ†ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.
                </span>
            </div>

            <div class="cost-formula-grid" style="margin-top: 1rem;">
                <div class="cf-field">
                    <label for="cf-monthly-orders">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´ Ø¯Ø± Ù…Ø§Ù‡</label>
                    <div class="cf-input-with-btn">
                        <input id="cf-monthly-orders" type="number" min="0" class="cf-input"
                            placeholder="Ù…Ø«Ù„Ø§Ù‹ Û²ÛµÛ°Û° Ø³ÙØ§Ø±Ø´ Ø¯Ø± Ù…Ø§Ù‡"
                            value="{{ monthly_orders_avg or '' }}">
                        <button type="button" class="cf-auto-btn" data-target="monthly-orders" title="Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÛŒØ¯Ù‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 8C2 4.68629 4.68629 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M14 8C14 11.3137 11.3137 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M2 8L5 5M14 8L11 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                    <span class="cf-helper">
                        Ø¨Ø±Ø§ÛŒ ØªÙ‚Ø³ÛŒÙ… Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª (Ù¾Ø±Ø³Ù†Ù„ØŒ Ø§Ø¬Ø§Ø±Ù‡ØŒ Ø§Ø³ØªÙ‡Ù„Ø§Ú©) Ø±ÙˆÛŒ Ù‡Ø± Ø³ÙØ§Ø±Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                    </span>
                </div>
                <div class="cf-field">
                    <label for="cf-avg-order-price">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø¨Ù„Øº Ù‡Ø± Ø³ÙØ§Ø±Ø´ </label>
                    <div class="cf-input-with-btn">
                        <input id="cf-avg-order-price" type="number" min="0" class="cf-input"
                            placeholder="Ù…Ø«Ù„Ø§Ù‹ ÛµÛ°Û°Ù¬Û°Û°Û°"
                            value="{{ avg_order_price or '' }}">
                        <button type="button" class="cf-auto-btn" data-target="avg-order-price" title="Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÛŒØ¯Ù‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 8C2 4.68629 4.68629 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M14 8C14 11.3137 11.3137 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M2 8L5 5M14 8L11 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                    <span class="cf-helper">
                        ØªØ®Ù…ÛŒÙ†ÛŒ Ø§Ø² Ù…ØªÙˆØ³Ø· Ù…Ø¨Ù„Øº Ù‡Ø± Ø±Ø³ÛŒØ¯ Ù…Ø´ØªØ±ÛŒ Ø¯Ø± Ù…Ø§Ù‡.
                    </span>
                </div>
                <div class="cf-field">
                    <label for="cf-cost-control">Ø¯Ø±ØµØ¯ Ú©Ø§Ø³Øª Ú©Ù†ØªØ±Ù„ (Ùª)</label>
                    <input id="cf-cost-control" type="number" min="0" max="100" class="cf-input"
                        placeholder="Ù…Ø«Ù„Ø§Ù‹ 10"
                        value="{{ cost_control_percent or '' }}">
                    <span class="cf-helper">
                        Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø­Ø§Ø´ÛŒÙ‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø±ÙˆÛŒ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§. ÙØ¹Ù„Ø§Ù‹ ÙÙ‚Ø· Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø±ÙˆÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
                    </span>
                </div>
            </div>

            <div class="cf-modal-footer">
                <button type="button" id="cf-close-btn" class="cf-btn-secondary">Ø¨Ø³ØªÙ†</button>
                <button type="button" id="cf-save-btn" class="cf-btn-primary">
                    Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const backdrop = document.getElementById('cost-formula-modal-backdrop');
        const openBtn = document.getElementById('open-cost-formula-modal');
        const closeBtn = document.getElementById('cf-close-btn');
        const saveBtn = document.getElementById('cf-save-btn');
        const rentCheckbox = document.getElementById('cf-has-rent');
        const rentAmount = document.getElementById('cf-rent-amount');
        const personnelList = document.getElementById('personnel-list');
        const addPersonnelRowBtn = document.getElementById('add-personnel-row');
        const monthlyOrdersInput = document.getElementById('cf-monthly-orders');
        const avgOrderPriceInput = document.getElementById('cf-avg-order-price');
        const depreciationInput = document.getElementById('cf-depreciation');
        const costControlInput = document.getElementById('cf-cost-control');
        const applySuggestedButtons = document.querySelectorAll('.apply-suggested-btn');
        const autoCalculateButtons = document.querySelectorAll('.cf-auto-btn');

        function openModal() {
            if (backdrop) {
                backdrop.style.display = 'flex';
            }
        }

        function closeModal() {
            if (backdrop) {
                backdrop.style.display = 'none';
            }
        }

        if (openBtn) openBtn.addEventListener('click', openModal);
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (backdrop) {
            backdrop.addEventListener('click', function (event) {
                if (event.target === backdrop) {
                    closeModal();
                }
            });
        }

        if (rentCheckbox && rentAmount) {
            // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡
            if (rentCheckbox.checked) {
                rentAmount.style.display = 'block';
            }

            rentCheckbox.addEventListener('change', function () {
                rentAmount.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    rentAmount.value = '';
                }
            });
        }

        if (addPersonnelRowBtn && personnelList) {
            addPersonnelRowBtn.addEventListener('click', function () {
                const row = document.createElement('div');
                row.className = 'personnel-row';
                row.innerHTML = ''
                    + '<input type="text" class="cf-input" placeholder="Ù†Ø§Ù… Ù¾Ø±Ø³Ù†Ù„">'
                    + '<input type="number" min="0" class="cf-input" placeholder="Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡ ">'
                    + '<button type="button" class="remove-personnel-btn" title="Ø­Ø°Ù">Ã—</button>';
                personnelList.appendChild(row);
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø¬Ø¯ÛŒØ¯
                const removeBtn = row.querySelector('.remove-personnel-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                    });
                }
            });
        }
        
        // Event delegation Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù Ù…ÙˆØ¬ÙˆØ¯
        if (personnelList) {
            personnelList.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-personnel-btn')) {
                    const row = e.target.closest('.personnel-row');
                    if (row) {
                        row.remove();
                    }
                }
            });
        }

        function parseIntSafe(value) {
            const n = parseInt(value, 10);
            return isNaN(n) ? 0 : n;
        }

        function parseFloatSafe(value) {
            const n = parseFloat(value);
            return isNaN(n) ? 0 : n;
        }

        if (saveBtn) {
            saveBtn.addEventListener('click', function () {
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø³Ù†Ù„ Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ø­Ù‚ÙˆÙ‚
                let normalizedPersonnel = [];
                if (personnelList) {
                    const rows = personnelList.querySelectorAll('.personnel-row');
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input');
                        if (inputs.length >= 2) {
                            const nameVal = (inputs[0].value || '').trim();
                            const salaryVal = parseIntSafe(inputs[1].value || '0');
                            if (nameVal || salaryVal > 0) {
                                normalizedPersonnel.push({
                                    name: nameVal,
                                    salary: salaryVal
                                });
                            }
                        }
                    });
                }

                const hasRent = !!(rentCheckbox && rentCheckbox.checked);
                const rentVal = hasRent ? parseIntSafe(rentAmount && rentAmount.value) : 0;
                const depreciationVal = parseIntSafe(depreciationInput && depreciationInput.value);
                const monthlyOrdersVal = parseIntSafe(monthlyOrdersInput && monthlyOrdersInput.value);
                const avgOrderPriceVal = parseIntSafe(avgOrderPriceInput && avgOrderPriceInput.value);
                const costControlVal = parseIntSafe(costControlInput && costControlInput.value);

                const payload = {
                    personnel: normalizedPersonnel,
                    has_rent: hasRent,
                    rent_amount: rentVal,
                    depreciation: depreciationVal,
                    monthly_orders_avg: monthlyOrdersVal,
                    avg_order_price: avgOrderPriceVal,
                    cost_control_percent: costControlVal
                };

                fetch('{{ url_for("menu.save_cost_formula_settings") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.status === 'success') {
                            // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù†ØŒ Ø¨Ø¹Ø¯ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø®Ù„Ø§ØµÙ‡ Ø¨Ø§Ù„Ø§ Ø¢Ù¾Ø¯ÛŒØª Ø´ÙˆØ¯
                            window.location.reload();
                        } else {
                            alert(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ±Ù…ÙˆÙ„ Ø¨Ù‡Ø§ÛŒ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡.');
                        }
                    })
                    .catch(() => {
                        alert('Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ±Ù…ÙˆÙ„ Ø¨Ù‡Ø§ÛŒ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.');
                    });
            });
        }

        // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
        if (autoCalculateButtons && autoCalculateButtons.length) {
            autoCalculateButtons.forEach(btn => {
                btn.addEventListener('click', async function() {
                    const target = this.getAttribute('data-target');
                    const btnElement = this;
                    
                    // Ù†Ù…Ø§ÛŒØ´ loading state
                    btnElement.disabled = true;
                    btnElement.style.opacity = '0.6';
                    
                    try {
                        const response = await fetch('{{ url_for("menu.calculate_order_stats") }}');
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            if (target === 'monthly-orders' && monthlyOrdersInput) {
                                monthlyOrdersInput.value = data.monthly_orders_avg || '';
                                // Trigger input event Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
                                monthlyOrdersInput.dispatchEvent(new Event('input'));
                            } else if (target === 'avg-order-price' && avgOrderPriceInput) {
                                avgOrderPriceInput.value = data.avg_order_price || '';
                                // Trigger input event Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
                                avgOrderPriceInput.dispatchEvent(new Event('input'));
                            }
                            
                            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ù…ÙˆÙ‚Øª
                            const originalTitle = btnElement.getAttribute('title');
                            btnElement.setAttribute('title', 'âœ“ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯!');
                            
                            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ú†Ø±Ø®Ø´ Ø¨Ù‡ Ø¢ÛŒÚ©ÙˆÙ†
                            const svg = btnElement.querySelector('svg');
                            if (svg) {
                                svg.style.transform = 'rotate(360deg)';
                                svg.style.transition = 'transform 0.5s ease';
                                setTimeout(() => {
                                    svg.style.transform = 'rotate(0deg)';
                                }, 500);
                            }
                            
                            setTimeout(() => {
                                btnElement.setAttribute('title', originalTitle);
                            }, 2000);
                        } else {
                            alert(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³ÙØ§Ø±Ø´Ø§Øª');
                        }
                    } catch (error) {
                        console.error('Error calculating order stats:', error);
                        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
                    } finally {
                        btnElement.disabled = false;
                        btnElement.style.opacity = '1';
                    }
                });
            });
        }
        
        // Ø§Ø¹Ù…Ø§Ù„ Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø³ÛŒØ³ØªÙ… Ø±ÙˆÛŒ Ù‚ÛŒÙ…Øª Ù…Ù†Ùˆ
        if (applySuggestedButtons && applySuggestedButtons.length) {
            applySuggestedButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    const itemId = this.dataset.itemId;
                    const price = parseInt(this.dataset.price || '0', 10);
                    if (!itemId || !price) return;
                    if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‚ÛŒÙ…Øª Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø³ÛŒØ³ØªÙ… ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯ØŸ')) {
                        return;
                    }
                    fetch(`/menu/item/${itemId}/apply-suggested-price`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ price })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                window.location.reload();
                            } else {
                                alert(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…Øª Ø¢ÛŒØªÙ….');
                            }
                        })
                        .catch(() => {
                            alert('Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…Øª Ø¢ÛŒØªÙ… Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.');
                        });
                });
            });
        }
    })();
</script>
{% endblock %}

